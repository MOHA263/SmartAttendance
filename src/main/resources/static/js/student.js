const submitBtn = document.getElementById("submitBtn");
const timerEl = document.getElementById("timer");
const requestBtn = document.getElementById("requestOtpBtn");
const waitingModal = document.getElementById("waitingModal");
const msg = document.getElementById("msg");

submitBtn.disabled = true;

let timerStarted = false;
let timerInterval = null; // global so we can stop it when OTP is verified
timerEl.style.color = "red";
timerEl.innerText = "â³";

/* ğŸ” CHECK OTP GENERATED BY TEACHER */
function checkOtpStatus() {
    fetch("/api/students/otp-status")
        .then(res => res.json())
        .then(isGenerated => {
            if (isGenerated && !timerStarted) {
                timerStarted = true;
                
                // Hide waiting modal
                waitingModal.classList.add("hidden");
                
                // Enable form
                submitBtn.disabled = false;
                msg.innerText = "";
                
                // Start 2-minute timer
                startTimer(120);
            }
        })
        .catch(err => console.error("Error checking OTP status:", err));
}

// Check every 2 seconds
setInterval(checkOtpStatus, 2000);

// Check immediately on page load
checkOtpStatus();

/* â± TIMER */
function startTimer(seconds) {
    let remainingTime = seconds;

    // Clear any existing timer before starting a new one
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }

    timerInterval = setInterval(() => {
        let min = Math.floor(remainingTime / 60);
        let sec = remainingTime % 60;

        timerEl.style.color = "#66a6ff";
        timerEl.innerText = `${min}:${sec < 10 ? "0" + sec : sec}`;
        remainingTime--;

        if (remainingTime < 0) {
            clearInterval(timerInterval);
            timerInterval = null;
            
            // Show OTP Expired
            timerEl.innerText = "Expired âŒ";
            timerEl.style.color = "#ff6b6b";
            
            msg.style.color = "#ff6b6b";
            msg.innerText = "OTP Expired âŒ - Please request a new OTP";
            
            submitBtn.disabled = true;
            submitBtn.style.opacity = "0.5";
            requestBtn.style.display = "block";
        }
    }, 1000);
}

/* âœ… SUBMIT OTP */
function submitOtp() {
    const rollNumber = document.getElementById("rollNumber").value.trim();
    const otp = document.getElementById("otp").value.trim();

    if (!rollNumber || !otp) {
        msg.style.color = "#ff6b6b";
        msg.innerText = "âš ï¸ Please fill all fields";
        return;
    }

    submitBtn.disabled = true;
    submitBtn.innerText = "Submitting...";
    msg.innerText = "";

    fetch("/api/students/submit-otp", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ rollNumber, otp })
    })
    .then(res => {
        if (!res.ok) return res.text().then(t => { throw new Error(t); });
        return res.text();
    })
    .then(() => {
        // âœ… Correct OTP â€“ stop the countdown timer
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }

        timerEl.innerText = "Verified âœ…";
        timerEl.style.color = "#4ade80";
        requestBtn.style.display = "none";

        msg.style.color = "#4ade80";
        msg.innerText = "âœ… Attendance Marked Successfully!";
        submitBtn.innerText = "âœ… Submitted";
        submitBtn.style.background = "#4ade80";
        document.getElementById("rollNumber").disabled = true;
        document.getElementById("otp").disabled = true;
    })
    .catch(err => {
        msg.style.color = "#ff6b6b";
        msg.innerText = "âŒ Invalid / Expired OTP";
        document.getElementById("otp").value = "";
        submitBtn.disabled = false;
        submitBtn.innerText = "Submit Attendance";
        console.log(err);
    });
}

/* ğŸ” REQUEST OTP AGAIN */
function requestOtp() {
    if (requestBtn.disabled) return;
    
    const rollNumber = document.getElementById("rollNumber").value.trim();
    
    if (!rollNumber) {
        msg.style.color = "#ff6b6b";
        msg.innerText = "âš ï¸ Please enter your roll number first";
        return;
    }
    
    requestBtn.disabled = true;
    requestBtn.innerText = "Requesting...";
    msg.innerText = "";

    fetch("/api/students/request-otp", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ rollNumber })
    })
        .then(res => {
            if (!res.ok) return res.text().then(t => { throw new Error(t); });
            return res.text();
        })
        .then(() => {
            msg.style.color = "#4ade80";
            msg.innerText = "âœ… OTP request sent to teacher ğŸ“©";
            requestBtn.innerText = "âœ… Requested";
            requestBtn.style.background = "#4ade80";
            
            // Reset for new OTP
            timerStarted = false;
            timerEl.innerText = "â³";
            timerEl.style.color = "#ff6b6b";
            document.getElementById("otp").value = "";
            submitBtn.disabled = true;
            
            // Check for new OTP after 3 seconds
            setTimeout(() => {
                checkOtpStatus();
            }, 3000);
        })
        .catch(_err => {
            msg.style.color = "#ff6b6b";
            msg.innerText = "âŒ Failed to request OTP. Try again.";
            requestBtn.disabled = false;
            requestBtn.innerText = "ğŸ” Request OTP Again";
        });
}
